# Переменные в Grafana

В Grafana можно использовать **переменные** (variables) для [динамической фильтрации данных](https://play.grafana.org/d/T512JVH7z/loki-nginx-service-mesh-json-version?orgId=1&from=now-6h&to=now&timezone=utc&var-datasource=ac4000ca-1959-45f5-aa45-2bd0898f7026&var-label_name=filename&var-label_value=%2Fvar%2Flog%2Fnginx%2Fjson_access.log&var-job=$__all&var-instance=$__all) в панелях. Переменные позволяют, например, выбирать конкретный `job`, `ip`, `port` или `instance` из выпадающего меню и автоматически обновлять данные на основе выбранного значения.

Разберем, как создать переменные для `job`, `ip`, `port` и `instance`, а затем использовать их в формуле PromQL.

---

### 1. **Добавление переменных в Grafana**

#### Шаг 1: Откройте настройки переменных
1. Перейдите в вашу панель Grafana.
2. Нажмите на значок "шестеренки" (⚙️) в верхней части панели для открытия настроек панели.
3. Выберите вкладку **Variables** (Переменные).

#### Шаг 2: Создайте переменную для каждого лейбла

Для каждого лейбла (`job`, `ip`, `port`, `instance`) создайте отдельную переменную:

---

##### **Переменная `job`:**
1. Нажмите **Add variable** (Добавить переменную).
2. Настройте параметры:
   - **Name**: `job` (имя переменной).
   - **Label**: `Job` (название, которое будет отображаться в интерфейсе).
   - **Type**: `Query` (запрос к Prometheus).
   - **Data source**: Выберите ваш источник данных Prometheus.
   - **Query**:  
     ```promql
     label_values(node_cpu_seconds_total, job)
     ```
     Эта функция извлекает уникальные значения лейбла `job` из метрики `node_cpu_seconds_total`.
   - **Refresh**: `On Dashboard Load` (обновлять при загрузке дашборда).
   - **Multi-value**: Включите, если хотите разрешить выбор нескольких значений.
   - **Include All option**: Включите, если хотите добавить опцию "All".

3. Нажмите **Add**.

---

##### **Переменная `ip`:**
1. Повторите шаги выше, но измените параметры:
   - **Name**: `ip`.
   - **Label**: `IP`.
   - **Query**:  
     ```promql
     label_values(node_cpu_seconds_total{job=~"$job"}, ip)
     ```
     Здесь мы фильтруем значения `ip` на основе выбранного значения переменной `job`.

---

##### **Переменная `port`:**
1. Повторите шаги выше:
   - **Name**: `port`.
   - **Label**: `Port`.
   - **Query**:  
     ```promql
     label_values(node_cpu_seconds_total{job=~"$job", ip=~"$ip"}, port)
     ```
     Здесь мы фильтруем значения `port` на основе выбранных значений `job` и `ip`.

---

##### **Переменная `instance`:**
1. Повторите шаги выше:
   - **Name**: `instance`.
   - **Label**: `Instance`.
   - **Query**:  
     ```promql
     label_values(node_cpu_seconds_total{job=~"$job", ip=~"$ip", port=~"$port"}, instance)
     ```
     Здесь мы фильтруем значения `instance` на основе выбранных значений `job`, `ip` и `port`.

---

### 2. **Использование переменных в формуле PromQL**

После создания переменных их можно использовать в запросах PromQL. Например, чтобы рассчитать среднее использование CPU в режиме `idle` с учетом выбранных переменных:

```promql
avg by (job, ip, port, instance) (
  rate(node_cpu_seconds_total{mode="idle", job=~"$job", ip=~"$ip", port=~"$port", instance=~"$instance"}[5m])
)
```

- `$job`, `$ip`, `$port`, `$instance`: Это ссылки на переменные, которые заменяются выбранными значениями.
- Если включен параметр **Include All**, переменная будет содержать регулярное выражение, соответствующее всем значениям.

---

### 3. **Пример работы с переменными**

#### Пример 1: Выбор всех экземпляров для конкретного `job`
Если вы выбрали `job="node"`, то переменные `ip`, `port` и `instance` будут автоматически обновлены, чтобы показывать только те значения, которые соответствуют этому `job`.

#### Пример 2: Фильтрация по IP
Если вы выбрали `ip="192.168.1.1"`, то переменные `port` и `instance` будут обновлены, чтобы показывать только те значения, которые соответствуют этому IP.

---

### 4. **Настройка интерфейса Grafana**

После создания переменных они автоматически появятся в верхней части панели в виде выпадающих меню. Вы можете выбрать значения для каждой переменной, и Grafana автоматически обновит данные на всех панелях, использующих эти переменные.
