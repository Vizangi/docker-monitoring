# Как писать формулы и делать группировки

Формула для расчета среднего использования CPU в режиме `idle`, сгруппированного по лейблам `job`, `ip`, `port` и `instance`. 

---

### Простая формула:

```promql
avg by (job, ip, port) (
  rate(node_cpu_seconds_total{mode="idle"}[5m])
)
```

---

### Разбор формулы:

1. **Основная метрика:**
   ```promql
   node_cpu_seconds_total{mode="idle"}
   ```
   - Мы выбираем метрику `node_cpu_seconds_total` только для режима работы CPU `idle`.

2. **Расчет скорости изменения:**
   ```promql
   rate(...[5m])
   ```
   - Функция `rate` вычисляет скорость изменения значения метрики за последние 5 минут (`[5m]`). Это полезно для получения текущего использования CPU.

3. **Группировка по лейблам:**
   ```promql
   avg by (job, ip, port) (...)
   ```
   - Мы группируем данные по лейблам `job`, `ip` и `port`, чтобы получить среднее значение для каждой комбинации этих лейблов.

---

### Что делает эта формула?

- Она рассчитывает **среднюю долю времени, которую CPU проводит в режиме `idle`**, за последние 5 минут.
- Результат будет сгруппирован по лейблам `job`, `ip` и `port`, что позволяет анализировать данные для разных задач, IP-адресов и портов.

---

### Пример вывода:

Предположим, у вас есть следующие экземпляры:

| job   | ip          | port | instance         |
|-------|-------------|------|------------------|
| node  | 192.168.1.1 | 9100 | 192.168.1.1:9100 |
| node  | 192.168.1.2 | 9100 | 192.168.1.2:9100 |

Результат запроса может выглядеть так:

| job   | ip          | port | value  |
|-------|-------------|------|--------|
| node  | 192.168.1.1 | 9100 | 0.85   |
| node  | 192.168.1.2 | 9100 | 0.90   |

Здесь `value` показывает среднюю долю времени, которое CPU проводит в режиме `idle`. Например, значение `0.85` означает, что CPU был неактивен 85% времени за последние 5 минут.

---

### Возможные модификации:

1. **Добавление лейбла `instance`:**
   Если нужно учитывать конкретный экземпляр:
   ```promql
   avg by (job, ip, port, instance) (
     rate(node_cpu_seconds_total{mode="idle"}[5m])
   )
   ```

2. **Изменение временного окна:**
   Если нужно увеличить или уменьшить интервал расчета:
   ```promql
   avg by (job, ip, port) (
     rate(node_cpu_seconds_total{mode="idle"}[1m])
   )
   ```

3. **Фильтрация по IP:**
   Если нужно рассчитать только для определенного IP:
   ```promql
   avg by (job, ip, port) (
     rate(node_cpu_seconds_total{mode="idle", ip="192.168.1.1"}[5m])
   )
   ```
