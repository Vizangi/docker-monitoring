# Регулярные выражения

В Grafana и PromQL регулярные выражения (regex) используются для фильтрации данных по лейблам. Это особенно полезно, когда нужно работать с динамическими значениями или группировать данные на основе определенных шаблонов.

Разберем базовые регулярные выражения, которые можно использовать в PromQL и Grafana, а также примеры их применения.

---

### 1. **Основные символы регулярных выражений**

| Символ | Описание                                                                 | Пример                  | Что будет найдено                     |
|--------|--------------------------------------------------------------------------|-------------------------|---------------------------------------|
| `.`    | Любой одиночный символ.                                                  | `node_cpu_seconds_total{instance=~"192.168..1"}` | `192.168.1.1`, `192.168.2.1`        |
| `*`    | Ноль или более повторений предыдущего символа или группы.                 | `node_cpu_seconds_total{instance=~"192.168.*"}` | `192.168.1.1`, `192.168.2.1`, `192.168.x.y` |
| `+`    | Одно или более повторений предыдущего символа или группы.                | `node_cpu_seconds_total{instance=~"192.168.+"}` | `192.168.1.1`, `192.168.2.1`, но не пустые строки |
| `?`    | Ноль или одно повторение предыдущего символа или группы.                 | `node_cpu_seconds_total{instance=~"192.168.1?"}` | `192.168.1`, `192.168.1.1`          |
| `[]`   | Один символ из указанных в скобках.                                      | `node_cpu_seconds_total{instance=~"192.168.1[0-9]"}` | `192.168.10`, `192.168.11`, ..., `192.168.19` |
| `^`    | Начало строки.                                                           | `node_cpu_seconds_total{instance=~"^192."}` | Все строки, начинающиеся с `192.`     |
| `$`    | Конец строки.                                                            | `node_cpu_seconds_total{instance=~"1$"}` | Все строки, заканчивающиеся на `1`    |
| `\|`    | Логическое "или".                                                        | `node_cpu_seconds_total{instance=~"192.168.1.1\|192.168.2.1"}` | `192.168.1.1` или `192.168.2.1`      |
| `()`   | Группировка символов или выражений.                                      | `node_cpu_seconds_total{instance=~"(192.168.1.1)\|(192.168.2.1)"}` | То же, что выше, но с группировкой   |

---

### 2. **Примеры использования регулярных выражений в PromQL**

#### Пример 1: Фильтрация по IP
Если нужно выбрать все экземпляры, где IP начинается с `192.168`:
```promql
node_cpu_seconds_total{instance=~"^192\\.168\\..+"}
```
- `^`: Указывает, что строка должна начинаться с `192.168`.
- `\\.`: Экранирование точки (точка — это специальный символ в regex).
- `.+`: Любое количество символов после `192.168`.

#### Пример 2: Выбор нескольких job
Если нужно выбрать метрики для двух job (`node` и `web`):
```promql
node_cpu_seconds_total{job=~"node\|web"}
```
- `\|`: Логическое "или".
- `"node\|web"`: Выбирает метрики, где `job` равно либо `node`, либо `web`.

#### Пример 3: Исключение определенных значений
Если нужно исключить метрики для job `test`:
```promql
node_cpu_seconds_total{job!~"test"}
```
- `!~`: Отрицание. Выбирает все значения, которые **не** соответствуют `test`.

#### Пример 4: Группировка по диапазону портов
Если нужно выбрать метрики для портов от `9100` до `9199`:
```promql
node_cpu_seconds_total{port=~"91[0-9]{2}"}
```
- `[0-9]`: Любая цифра.
- `{2}`: Ровно два повторения предыдущего символа.

---

### 3. **Использование регулярных выражений в Grafana**

#### Пример 1: Переменная с регулярным выражением
При создании переменной в Grafana можно использовать регулярные выражения для фильтрации значений. Например, если нужно выбрать только IP-адреса, начинающиеся с `192.168`:
```promql
label_values(node_cpu_seconds_total{instance=~"^192\\.168\\..+"}, ip)
```

#### Пример 2: Множественный выбор
Если вы хотите разрешить выбор нескольких значений через переменную, используйте регулярное выражение в запросе:
```promql
node_cpu_seconds_total{job=~"$job", ip=~"$ip"}
```
Здесь `$job` и `$ip` будут заменены на выбранные значения переменных.

---

### 4. **Частые ошибки и как их избежать**

1. **Экранирование точек**:  
   Точка (`.`) — это специальный символ в регулярных выражениях. Чтобы найти именно точку, её нужно экранировать: `\\.`.

2. **Неправильное использование `^` и `$`**:  
   Эти символы обозначают начало и конец строки соответственно. Если вы забудете их, регулярное выражение может сработать неправильно.

3. **Лишние пробелы**:  
   В PromQL пробелы могут привести к ошибкам. Например, `{job=~" node "}` не найдёт ничего, потому что пробелы учитываются.
